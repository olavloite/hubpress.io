<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Real World Example for Google Cloud Spanner - JPA - Hibernate</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://olavloite.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//olavloite.github.io/themes/casper/assets/css/screen.css?v=1495883620691" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="canonical" href="https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Real World Example for Google Cloud Spanner - JPA - Hibernate" />
    <meta property="og:description" content="https://github.com/olavloite/github-monitor https://github.com/olavloite/gaf The combination of the two above projects show a real world example of how an application can be developed using JPA/Hibernate in combination with Google Cloud Spanner. The project depends on two important libraries: Google Cloud Spanner JDBC Driver" />
    <meta property="og:url" content="https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html" />
    <meta property="article:published_time" content="2017-05-27T00:00:00.000Z" />
    <meta property="article:tag" content="Google_Cloud_Spanner" />
    <meta property="article:tag" content="JPA" />
    <meta property="article:tag" content="Hibernate" />
    <meta property="article:tag" content="Java" />
    <meta property="article:tag" content="Spring" />
    <meta property="article:tag" content="Spring_Boot" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Real World Example for Google Cloud Spanner - JPA - Hibernate" />
    <meta name="twitter:description" content="https://github.com/olavloite/github-monitor https://github.com/olavloite/gaf The combination of the two above projects show a real world example of how an application can be developed using JPA/Hibernate in combination with Google Cloud Spanner. The project depends on two important libraries: Google Cloud Spanner JDBC Driver" />
    <meta name="twitter:url" content="https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "",
    "author": {
        "@type": "Person",
        "name": "Knut Olav Løite",
        "image": "https://avatars0.githubusercontent.com/u/1196707?v=3",
        "url": "https://olavloite.github.io/author/olavloite/",
        "sameAs": "https://www.linkedin.com/in/knutolavloite/"
    },
    "headline": "Real World Example for Google Cloud Spanner - JPA - Hibernate",
    "url": "https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html",
    "datePublished": "2017-05-27T00:00:00.000Z",
    "keywords": "Google_Cloud_Spanner, JPA, Hibernate, Java, Spring, Spring_Boot",
    "description": "https://github.com/olavloite/github-monitor https://github.com/olavloite/gaf The combination of the two above projects show a real world example of how an application can be developed using JPA/Hibernate in combination with Google Cloud Spanner. The project depends on two important libraries: Google Cloud Spanner JDBC Driver"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="" href="https://olavloite.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
</head>
<body class="post-template tag-Google-Cloud-Spanner tag-JPA tag-Hibernate tag-Java tag-Spring tag-Spring-Boot nav-closed">

    

    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-Google-Cloud-Spanner tag-JPA tag-Hibernate tag-Java tag-Spring tag-Spring-Boot">

        <header class="post-header">
            <h1 class="post-title">Real World Example for Google Cloud Spanner - JPA - Hibernate</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2017-05-27">27 May 2017</time>  on <a href="https://olavloite.github.io/tag/Google-Cloud-Spanner/">Google_Cloud_Spanner</a>, <a href="https://olavloite.github.io/tag/JPA/">JPA</a>, <a href="https://olavloite.github.io/tag/Hibernate/">Hibernate</a>, <a href="https://olavloite.github.io/tag/Java/">Java</a>, <a href="https://olavloite.github.io/tag/Spring/">Spring</a>, <a href="https://olavloite.github.io/tag/Spring-Boot/">Spring_Boot</a>
            </section>
        </header>

        <section class="post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/olavloite/github-monitor" class="bare">https://github.com/olavloite/github-monitor</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/olavloite/gaf" class="bare">https://github.com/olavloite/gaf</a></p>
</div>
<div class="paragraph">
<p>The combination of the two above projects show a real world example of how an application can be developed using JPA/Hibernate in combination with Google Cloud Spanner.</p>
</div>
<div class="paragraph">
<p>The project depends on two important libraries:</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_google_cloud_spanner_jdbc_driver">Google Cloud Spanner JDBC Driver</h3>
<div class="paragraph">
<p>An open source JDBC Driver for Google Cloud Spanner that supports a number of features not supported by the
official JDBC Driver from Google:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>DML-statements (UPDATE, INSERT, DELETE)</p>
</li>
<li>
<p>DDL-statements (CREATE TABLE, ALTER TABLE, &#8230;&#8203;)</p>
</li>
<li>
<p>Transactions</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>More information on this driver can be found here:
<a href="https://github.com/olavloite/spanner-jdbc" class="bare">https://github.com/olavloite/spanner-jdbc</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_google_cloud_spanner_dialect">Google Cloud Spanner Dialect</h3>
<div class="paragraph">
<p>A Hibernate Dialect for Google Cloud Spanner. More information on this dialect can be found here:
<a href="https://github.com/olavloite/spanner-hibernate" class="bare">https://github.com/olavloite/spanner-hibernate</a></p>
</div>
<div class="paragraph">
<p>The dialect supports schema generation.</p>
</div>
</div>
<div class="sect1">
<h2 id="_example_project">Example Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The example project is a web application that reads GitHub Repositories from GitHub and stores these in a Google Cloud Spanner database. The main goal of this project is to show how you could develop a real world application with Google Cloud Spanner / JPA / Hibernate. The functionality of the example project itself is secondary.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_base_entity">Base Entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project uses a general application framework that has been used to develop other applications using PostgreSQL. The base of the framework has only been altered slightly in order to get it compatible with Cloud Spanner. The most important change is the way database id&#8217;s are generated. PostgreSQL supports sequences, Cloud Spanner does not. Id&#8217;s are therefore generated by the application framework instead of by the database.</p>
</div>
<div class="paragraph">
<p>The base entity is shown in the below code snippet (some methods have been removed for brevity)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@MappedSuperclass
@Cacheable(value = true)
@BatchSize(size = 20)
public abstract class FriggEntity implements Serializable
{
	private static final long serialVersionUID = 1L;

	private static final NoArgGenerator GENERATOR = Generators.randomBasedGenerator();

	/**
	 * ID is generated from the UUID
	 */
	@Id
	@FriggDomainDescriptor(excludedFromDataPanel = true)
	private Long id;

	@Column(nullable = false, unique = true, length = 20)
	@FriggDomainDescriptor(excludedFromDataPanel = true)
	private UUID uuid;

	@FriggDomainDescriptor(defaultVisibleInDataPanel = false, defaultVisibleInAutoForm = false)
	@Column(nullable = false)
	private Date created;

	@FriggDomainDescriptor(defaultVisibleInDataPanel = false, defaultVisibleInAutoForm = false)
	@Column(nullable = false)
	private Date updated;

	protected FriggEntity()
	{
	}

	public UUID getUuid()
	{
		if (uuid == null)
			uuid = GENERATOR.generate();
		return uuid;
	}

	public void setUuid(UUID uuid)
	{
		this.uuid = uuid;
	}

	@PrePersist
	protected void onCreate()
	{
		created = new Date();
		updated = new Date();
		if (uuid == null)
			uuid = GENERATOR.generate();
		if (id == null)
			id = uuid.getMostSignificantBits() ^ uuid.getLeastSignificantBits();
	}

	@PreUpdate
	protected void onUpdate()
	{
		updated = new Date();
	}

	@Override
	public boolean equals(Object other)
	{
		if (this == other)
			return true;
		if (!(other instanceof FriggEntity))
			return false;

		return ((FriggEntity) other).getUuid().equals(this.getUuid());
	}

	@Override
	public int hashCode()
	{
		return getUuid().hashCode();
	}

	@Override
	public boolean isSaved()
	{
		return getId() != null;
	}

}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The primary key of the base entity is a long without any functional meaning.</p>
</li>
<li>
<p>The entity contains a UUID that is generated by the application. This makes it possible to compare entities with each other that have not yet been saved. This UUID is also used to generate the primary key value for the entity.</p>
</li>
<li>
<p>The entity has created/updated timestamps that are automatically filled.</p>
</li>
<li>
<p>The entity uses the @PrePersist and @PreUpdate annotations of JPA to generate values for id, uuid, created and updated.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_account_entity">Account Entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Account entity is an extension of the base entity that represents a user account. Once again, large parts of the code has been left out for brevity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Entity
@Table(indexes = { @Index(unique = true, columnList = "username") })
public class Account extends FriggEntity
{
	private static final long serialVersionUID = 1L;

	@Column(length = 30, nullable = false)
	private String username;

	@FriggDomainDescriptor(header = "Password", description = "Password", passwordField = true)
	@Transient
	private String password;

	@FriggDomainDescriptor(excludedFromDataPanel = true, defaultVisibleInAutoForm = false)
	@Column(length = 200, nullable = true)
	private String passwordHash;

	@FriggDomainDescriptor(excludedFromDataPanel = true, defaultVisibleInAutoForm = false)
	@Column(length = 200, nullable = true)
	private String salt;

	@Column(length = 30, nullable = true)
	private String activeDirectoryDomain;

	@OneToMany(fetch = FetchType.LAZY, mappedBy = "account")
	private List&lt;RoleAccount&gt; roles = new ArrayList&lt;RoleAccount&gt;();

	public Account()
	{
	}

}</pre>
</div>
</div>
<div class="paragraph">
<p>The Account entity extends the base entity and adds additional columns. The entity is stored in a table with a default name (ACCOUNT), and includes a unique index on the column username. The name of the index is generated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_roleaccount_entity">RoleAccount Entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RoleAccount stores relations between accounts and roles. I consider it good practice to explicitly define these many-to-many relations as a stand alone entity, and not using a many-to-many annotation with an automatically generated relations table. You gain more control over the relation by defining it as an entity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Entity
@Table(indexes = { @Index(name = "IDX_ROLEACCOUNT_ACCOUNT", columnList = "account"),
		@Index(name = "IDX_ROLEACCOUNT_ROLE", columnList = "role") })
public class RoleAccount extends FriggEntity
{
	private static final long serialVersionUID = 1L;

	@FriggDomainDescriptor(defaultEditableInAutoForm = false)
	@ManyToOne(fetch = FetchType.EAGER)
	@JoinColumn(name = "account", nullable = false)
	private Account account;

	@ManyToOne(fetch = FetchType.EAGER)
	@JoinColumn(name = "role", nullable = false)
	private Role role;

	public RoleAccount()
	{
	}

	public RoleAccount(Account account, Role role)
	{
		setAccount(account);
		setRole(role);
	}

}</pre>
</div>
</div>
<div class="paragraph">
<p>The properties account and role have been annotated with @JoinColumn. Normally, this would lead to the generation of a table with two foreign key constraints. Google Cloud Spanner does however not support traditional foreign key constraints, and these are therefore also not generated.</p>
</div>
<div class="paragraph">
<p>Google Cloud Spanner does support Interleaved Tables (<a href="https://cloud.google.com/spanner/docs/schema-and-data-model#creating_interleaved_tables" class="bare">https://cloud.google.com/spanner/docs/schema-and-data-model#creating_interleaved_tables</a>). Interleaved tables are never generated by the schema generation of the Google Cloud Spanner Hibernate dialect. If you want a schema using interleaved tables, you will have to create that part of the schema manually.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_the_project">Getting the Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The example project is a multi-module Maven project. It also depends on another multi-module Maven project (General Application Framework, gaf, <a href="https://github.com/olavloite/gaf" class="bare">https://github.com/olavloite/gaf</a>). You should get both from GitHub and import them into your IDE.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/olavloite/github-monitor" class="bare">https://github.com/olavloite/github-monitor</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/olavloite/gaf" class="bare">https://github.com/olavloite/gaf</a></p>
</div>
</div>
</div>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="https://olavloite.github.io/author/olavloite/" style="background-image: url(https://avatars0.githubusercontent.com/u/1196707?v&#x3D;3)"><span class="hidden">Knut Olav Løite's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="https://olavloite.github.io/author/olavloite/">Knut Olav Løite</a></h4>

                    <p>Read <a href="https://olavloite.github.io/author/olavloite/">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Deventer, Netherlands</span>
                    <span class="author-link icon-link"><a href="https://www.linkedin.com/in/knutolavloite/">https://www.linkedin.com/in/knutolavloite/</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Real%20World%20Example%20for%20Google%20Cloud%20Spanner%20-%20JPA%20-%20Hibernate&amp;url=https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://olavloite.github.io/2017/05/27/Real-World-Example-for-Google-Cloud-Spanner-JPA-Hibernate.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


    </article>

</main>

<aside class="read-next">
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="https://olavloite.github.io"></a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="http://hubpress.io">HubPress</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

    <script type="text/javascript" src="//olavloite.github.io/themes/casper/assets/js/jquery.fitvids.js?v=1495883620691"></script>
    <script type="text/javascript" src="//olavloite.github.io/themes/casper/assets/js/index.js?v=1495883620691"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-93535827-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
